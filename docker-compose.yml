services:
    postgres:
        image: postgres:16
        container_name: fink_pg
        environment:
            POSTGRES_USER: fink
            POSTGRES_PASSWORD: fink
            POSTGRES_DB: fink
        ports:
            - "5433:5432"
        volumes:
            - fink_pg:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U fink -d fink"]
            interval: 5s
            timeout: 3s
            retries: 20
        restart: unless-stopped

    redis:
        image: redis:7
        container_name: fink_redis
        ports:
            - "6379:6379"
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 20
        restart: unless-stopped

    api:
        build: .
        container_name: fink_api
        env_file: .env
        environment:
            DATABASE_URL: postgresql+asyncpg://fink:fink@postgres:5432/fink
            DATABASE_URL_SYNC: postgresql://fink:fink@postgres:5432/fink
            REDIS_URL: redis://redis:6379/0
            ENVIRONMENT: development
        ports:
            - "8000:8000"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        command:
            [
                "python",
                "-m",
                "uvicorn",
                "app.main:app",
                "--host",
                "0.0.0.0",
                "--port",
                "8000"
            ]
        volumes:
            - .:/app
        restart: unless-stopped

    pgweb:
        image: sosedoff/pgweb:latest
        container_name: fink_pgweb
        profiles:
            - dev
        command: ["--url", "postgres://fink:fink@postgres:5432/fink?sslmode=disable"]
        ports:
            - "8081:8081"
        depends_on:
            postgres:
                condition: service_healthy
        restart: unless-stopped

volumes:
    fink_pg:
